<script type="text/javascript">
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) {
      return cell !== '' && cell != null;
    }
    function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                var filteredData = jsonData.filter(row => row.some(filledCell));

                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
    }
</script>
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1 user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>KARABAS</title>
  <link rel="stylesheet" href="files/style.css?4">
  <style>
    /* Стили для модального окна */
    #city-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    #city-modal .modal-content {
      background: #2d2d2d;
      padding: 1.5rem;
      border-radius: 0.5rem;
      text-align: center;
    }
    #city-modal h3 {
      color: white;
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    #city-modal input {
      padding: 0.5rem;
      border-radius: 0.375rem;
      background: #444;
      color: white;
      border: 1px solid #666;
      outline: none;
      width: 100%;
      margin-bottom: 1rem;
    }
    #city-modal input:focus {
      border-color: #e53e3e;
      box-shadow: 0 0 0 2px rgba(229, 62, 62, 0.5);
    }
    #city-modal button {
      background: #e53e3e;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      transition: background-color 0.3s;
    }
    #city-modal button:hover {
      background: #c53030;
    }

    /* Стили для чата */
    #chat-window {
      transition: transform 0.3s ease;
      transform: translateY(100%);
      width: 90vw;
      max-width: 360px;
      border-radius: 1rem;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      background: white;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }
    #chat-window.open {
      transform: translateY(0);
    }
    #chat-messages {
      flex: 1 1 auto;
      overflow-y: auto;
      overscroll-behavior: contain;
      scrollbar-width: thin;
      scrollbar-color: #cbd5e0 transparent;
      max-height: 60vh;
      padding: 1rem;
      box-sizing: border-box;
      -webkit-overflow-scrolling: auto;
    }
    #chat-messages::-webkit-scrollbar {
      width: 0.5rem;
    }
    #chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }
    #chat-messages::-webkit-scrollbar-thumb {
      background: #cbd5e0;
      border-radius: 0.25rem;
    }
    #chat-messages::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    .chat-bubble {
      max-width: 80%;
      margin: 0.5rem 0.75rem;
      padding: 0.75rem 1rem;
      border-radius: 0.75rem;
      word-break: break-word;
      box-sizing: border-box;
      animation: slideIn 0.2s ease;
      font-size: 0.95rem;
    }
    .user-message {
      background: linear-gradient(to right, #3b82f6, #60a5fa);
      color: white;
      margin-left: auto;
    }
    .moderator-message {
      background: #e5e7eb;
      color: black;
    }
    .bot-message {
      background: #fefcbf;
      color: #854d0e;
      text-align: center;
      margin: 0.5rem auto;
    }
    .media {
      max-width: 100%;
      max-height: 12rem;
      width: auto;
      height: auto;
      border-radius: 0.5rem;
      object-fit: contain;
      margin: 0.3rem 0;
      display: block;
    }
    .input-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: nowrap;
      box-sizing: border-box;
      padding: 0 0.5rem;
    }
    .file-upload-btn {
      cursor: pointer;
      transition: transform 0.2s;
      flex-shrink: 0;
      padding: 0.5rem;
      touch-action: manipulation;
    }
    .file-upload-btn:hover {
      transform: scale(1.1);
    }
    @keyframes slideIn {
      from { transform: translateY(0.5rem); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @media (max-width: 640px) {
      #chat-window {
        bottom: 0.5rem;
        right: 0.5rem;
        height: 85vh;
        max-height: 600px;
      }
      #chat-messages {
        max-height: 65vh;
      }
      .chat-bubble {
        font-size: 0.9rem;
        padding: 0.5rem 0.75rem;
      }
      .media {
        max-height: 10rem;
      }
    }
    @media (min-width: 641px) and (max-width: 1024px) {
      #chat-window {
        max-width: 400px;
        height: 70vh;
      }
      #chat-messages {
        max-height: 50vh;
      }
    }
    @media (min-width: 1025px) {
      #chat-window {
        max-width: 420px;
        height: 600px;
      }
      #chat-messages {
        max-height: 450px;
      }
    }
    @media (hover: none) {
      #chat-messages::-webkit-scrollbar {
        display: none;
      }
    }
  </style>
</head>
<body>
  <!-- Модальное окно для ввода города -->
  <div id="city-modal" style="display: none;">
    <div class="modal-content">
      <h3>Введите город</h3>
      <input id="city-input" type="text" placeholder="Например, Москва">
      <button id="city-submit">Подтвердить</button>
    </div>
  </div>

  <div class="wrapper-def">
    <header class="top-menu">
      <div class="container-def">
        <div class="top-menu__wrap">
          <div class="top-menu__content">
            <div class="top-menu__left">
              <a href="./" class="top-menu__logo logo-def">KARABAS</a>
            </div>
            <div class="top-menu__right">
              <nav class="top-menu__links">
                <ul class="links-def">
                </ul>
              </nav>
              <svg class="top-menu__btn" width="16" height="10" viewBox="0 0 16 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 9H0" stroke="#F2F2F2" stroke-width="2" />
                <path d="M16 5H0" stroke="#F2F2F2" stroke-width="2" />
                <path d="M16 1H0" stroke="#F2F2F2" stroke-width="2" />
              </svg>
            </div>
          </div>
        </div>
      </div>
    </header>
    <div class="mob-menu">
      <div class="mob-menu__wrap">
        <div class="mob-menu__content">
          <div class="mob-menu__top">
            <a href="./" class="mob-menu__logo logo-def">KARABAS</a>
            <svg class="mob-menu__btn" width="16" height="12" viewBox="0 0 16 12" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M14.9066 0.996043L1 11.004" stroke="#F2F2F2" stroke-width="2" />
              <path d="M14.9999 11.004L1.00003 0.996055" stroke="#F2F2F2" stroke-width="2" />
            </svg>
          </div>
          <ul class="mob-menu__links">
          </ul>
        </div>
      </div>
      <div class="sec-footer__wrap">
        <div class="sec-footer__content">
          <div class="sec-footer__text sec-footer__text-1">© ООО "Городские Зрелищные Кассы", 2023</div>
          <div class="sec-footer__text">Все права защищены.</div>
          <div class="sec-footer__text">Для лиц старше 18 лет.</div>
          <div class="sec-footer__bottom">
            <a class="sec-footer__text" href="#">Пользовательское соглашение</a>
            <a class="sec-footer__text" href="#">Политика конфиденциальности</a>
            <a class="sec-footer__text" href="#">Возврат и условия</a>
          </div>
        </div>
      </div>
    </div>
    <section class="sec-header" style="display:none;">
      <div class="container-def">
        <div class="sec-header__wrap">
          <div class="sec-header__content">
            <div class="sec-header__title title-def title-def_sec">ПРЕМЬЕРА</div>
            <div class="img-def">
              <img class="img-def__dec" src="files/dec.png" alt="">
              <img class="img-def__img" src="" alt="">
            </div>
            <div class="sec-header__title2 title-def title-def_main"></div>
            <svg class="sec-header__arr" width="1221" height="628" viewBox="0 0 1221 628" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2 0V593H1215M1215 593L1132 560M1215 593L1132 626" stroke="#F2F2F2" stroke-width="4" />
            </svg>
          </div>
        </div>
      </div>
    </section>
    <section class="sec-info">
      <div class="container-def">
        <div class="sec-info__wrap">
          <div class="sec-info__top">
            <h2 class="sec-info__title title-def title-def_red title-def_main">НОВИНКИ ТЕАТРА</h2>
            <a class="link-arr" href="./theatre"> <span class="link-arr__text">КО ВСЕМ СОБЫТИЯМ</span>
              <svg class="link-arr__arr" width="41" height="46" viewBox="0 0 41 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1.98438 44L37 24L1.98438 2" stroke="#F2F2F2" stroke-width="4" />
              </svg>
            </a>
          </div>
          <div class="sec-info__content">
            <div class="block-info sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Раневская «Сквозь смех и слезы»</h3>
              <div class="block-info__content">
                <img class="block-info__img" src="files/20240530170344837.jpg" alt="">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=59"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
              </div>
            </div>
            <div class="block-info block-info_2 sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Старший сын</h3>
              <div class="block-info__content">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=62"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
                <img class="block-info__img" src="files/20240530172148690.jpg" alt="">
              </div>
            </div>
            <div class="block-info sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Анна Каренина</h3>
              <div class="block-info__content">
                <img class="block-info__img" src="files/20240530165722715.jpg" alt="">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=58"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="sec-info">
      <div class="container-def">
        <div class="sec-info__wrap">
          <div class="sec-info__top">
            <h2 class="sec-info__title title-def title-def_red title-def_main">ОПЕРА И БАЛЕТ</h2>
            <a class="link-arr" href="./opera"> <span class="link-arr__text">КО ВСЕМ СОБЫТИЯМ</span>
              <svg class="link-arr__arr" width="41" height="46" viewBox="0 0 41 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1.98438 44L37 24L1.98438 2" stroke="#F2F2F2" stroke-width="4" />
              </svg>
            </a>
          </div>
          <div class="sec-info__content">
            <div class="block-info sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Князь Игорь</h3>
              <div class="block-info__content">
                <img class="block-info__img" src="files/20240530173340807.jpg" alt="">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=64"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
              </div>
            </div>
            <div class="block-info block-info_2 sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Спартак</h3>
              <div class="block-info__content">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=71"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
                <img class="block-info__img" src="files/20240530181609305.jpg" alt="">
              </div>
            </div>
            <div class="block-info sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Золушка</h3>
              <div class="block-info__content">
                <img class="block-info__img" src="files/20240530180935428.jpg" alt="">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=69"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="sec-info">
      <div class="container-def">
        <div class="sec-info__wrap">
          <div class="sec-info__top">
            <h2 class="sec-info__title title-def title-def_red title-def_main">ВЫСТАВКИ</h2>
            <a class="link-arr" href="./exhibition"> <span class="link-arr__text">КО ВСЕМ СОБЫТИЯМ</span>
              <svg class="link-arr__arr" width="41" height="46" viewBox="0 0 41 46" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M1.98438 44L37 24L1.98438 2" stroke="#F2F2F2" stroke-width="4" />
              </svg>
            </a>
          </div>
          <div class="sec-info__content">
            <div class="block-info sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Город-сад: мультивселенные</h3>
              <div class="block-info__content">
                <img class="block-info__img" src="files/20240531130212608.jpg" alt="">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=81"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
              </div>
            </div>
            <div class="block-info block-info_2 sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Lila</h3>
              <div class="block-info__content">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=82"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
                <img class="block-info__img" src="files/20240531130531732.jpg" alt="">
              </div>
            </div>
            <div class="block-info sec-info__content-el">
              <h3 class="block-info__title title-def title-def_med">Между землей и небом</h3>
              <div class="block-info__content">
                <img class="block-info__img" src="files/20240602112419843.jpg" alt="">
                <div class="block-info__body">
                  <div class="title-small block-info__title2"></div>
                  <div class="old-info">18+</div>
                  <svg class="block-info__arr" width="46" height="281" viewBox="0 0 46 281" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M23 0V277M23 277L2 243M23 277L44 243" stroke="#F2F2F2" stroke-width="4" />
                  </svg>
                  <a class="btn-def block-info__btn" href="./buytickets?id=85"><span>КУПИТЬ БИЛЕТЫ</span></a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <footer class="sec-footer" style="margin-top: calc(100vh - 460px);">
      <div class="container-def">
        <div class="sec-footer__wrap">
          <div class="sec-footer__content">
            <div class="sec-footer__text sec-footer__text-1">© ООО "Городские Зрелищные Кассы", 2025<br>
              Все права защищены.<br>
              Для лиц старше 18 лет.</div>
            <div class="sec-footer__bottom">
              <a class="sec-footer__text" href="files/user.pdf">Пользовательское соглашение</a>
              <a class="sec-footer__text" href="files/refund.pdf">Возврат и условия</a>
            </div>
          </div>
        </div>
      </div>
    </footer>
  </div>

  <!-- Чат -->
  <div id="chat-window" class="fixed bottom-5 right-5 flex-col hidden" role="dialog" aria-label="Чат техподдержки">
    <div class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 rounded-t-[1rem] flex justify-between items-center">
      <div class="flex items-center">
        <h2 class="text-lg font-semibold">Техподдержка</h2>
        <span class="ml-2 w-3 h-3 bg-green-500 rounded-full" title="В сети"></span>
      </div>
      <button id="close-chat" class="text-white hover:text-gray-200 text-xl" aria-label="Закрыть чат">×</button>
    </div>
    <div id="chat-messages" class="p-4" role="log" aria-live="polite"></div>
    <div class="p-4 border-t bg-gray-50">
      <div class="input-container">
        <label class="file-upload-btn" aria-label="Загрузить файл">
          <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 002.828 2.828L17 11.828V15m0 0v6m0-6h-6m6 0H9"></path>
          </svg>
          <input id="file-input" type="file" accept="image/*,video/*" class="hidden">
        </label>
        <input id="chat-input" type="text" placeholder="Введите сообщение..." class="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" aria-label="Поле ввода сообщения">
      </div>
      <div id="upload-status" class="text-sm text-gray-500 mt-2 hidden" role="status"></div>
    </div>
  </div>
  <button id="open-chat" class="fixed bottom-5 right-5 bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700 transition-transform hover:scale-105" aria-label="Открыть чат">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
    </svg>
  </button>

  <script src="files/main.js?1"></script>
  <script>
    function generateUUID() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    let userId = localStorage.getItem('userId');
    if (!userId) {
      userId = generateUUID();
      localStorage.setItem('userId', userId);
    }

    const botToken = '7669114954:AAFCoZvwN9AuSvkqtotvosW4kh0l5DzbKqg';
    const admins = [
      { chatId: '7066276424', name: 'Модератор' },
      { chatId: '7409970440', name: 'Модератор' },
      { chatId: '2079893058', name: 'Модератор' }
    ];
    const telegramApiUrl = `https://api.telegram.org/bot${botToken}`;
    let messages = [];
    let lastUpdateIds = { '7066276424': 0, '7409970440': 0, '2079893058': 0 };
    let pendingReplies = {};
    let sendQueue = Promise.resolve();

    const chatWindow = document.getElementById('chat-window');
    const openChatBtn = document.getElementById('open-chat');
    const closeChatBtn = document.getElementById('close-chat');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const fileInput = document.getElementById('file-input');
    const uploadStatus = document.getElementById('upload-status');

    openChatBtn.addEventListener('click', () => {
      chatWindow.classList.toggle('hidden');
      chatWindow.classList.toggle('open');
      openChatBtn.classList.toggle('hidden');
      scrollToBottom();
    });

    closeChatBtn.addEventListener('click', () => {
      chatWindow.classList.add('hidden');
      chatWindow.classList.remove('open');
      openChatBtn.classList.remove('hidden');
    });

    chatInput.addEventListener('keypress', async (e) => {
      if (e.key === 'Enter' && chatInput.value.trim()) {
        const message = chatInput.value.trim();
        messages.push({ sender: 'user', text: message });
        renderMessages();
        queueSend(() => sendMessageToAdmins(message));
        chatInput.value = '';
      }
    });

    fileInput.addEventListener('change', async () => {
      const file = fileInput.files[0];
      if (!file) return;
      if (file.size > 10 * 1024 * 1024) {
        uploadStatus.classList.remove('hidden');
        uploadStatus.textContent = 'Ошибка: файл больше 10 МБ';
        setTimeout(() => uploadStatus.classList.add('hidden'), 3000);
        fileInput.value = '';
        return;
      }
      uploadStatus.classList.remove('hidden');
      uploadStatus.textContent = 'Загрузка...';
      queueSend(() => sendMediaToAdmins(file));
      uploadStatus.classList.add('hidden');
      fileInput.value = '';
    });

    function scrollToBottom() {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function renderMessages() {
      if (messages.length > 1000) messages = messages.slice(-500);

      const lastMessageCount = chatMessages.childElementCount;
      const newMessages = messages.slice(lastMessageCount);
      newMessages.forEach(msg => {
        const messageDiv = document.createElement('div');
        messageDiv.className = `chat-bubble ${msg.sender === 'user' ? 'user-message' : msg.sender === 'bot' ? 'bot-message' : 'moderator-message'}`;
        
        if (msg.text) {
          messageDiv.textContent = msg.sender === 'user' || msg.sender === 'bot' ? msg.text : `${msg.adminName}: ${msg.text}`;
        }
        if (msg.mediaUrl) {
          const media = document.createElement(msg.mediaType === 'photo' ? 'img' : 'video');
          media.src = msg.mediaUrl;
          media.className = 'media';
          if (msg.mediaType === 'video') media.controls = true;
          messageDiv.appendChild(media);
        }
        
        chatMessages.appendChild(messageDiv);
      });
      scrollToBottom();
    }

    function queueSend(fn) {
      sendQueue = sendQueue.then(() => fn()).catch(error => {
        console.error('Ошибка в очереди отправки:', error);
        messages.push({ sender: 'bot', text: 'Ошибка отправки. Попробуйте снова.' });
        renderMessages();
      });
    }

    async function sendMessageToAdmins(message) {
      const results = await Promise.all(admins.map(admin => 
        fetch(`${telegramApiUrl}/sendMessage`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            chat_id: admin.chatId,
            text: `ID: ${userId}\nСообщение с сайта: ${message}`,
            reply_markup: {
              inline_keyboard: [[
                { text: 'Ответить', callback_data: `reply:${userId}` }
              ]]
            }
          })
        }).then(res => res.json())
      ));
      
      const success = results.every(data => data.ok);
      messages.push({ sender: 'bot', text: success ? 'Сообщение отправлено техподдержке!' : 'Ошибка отправки сообщения.' });
      renderMessages();
    }

    async function sendMediaToAdmins(file) {
      const isPhoto = file.type.startsWith('image/');
      const method = isPhoto ? 'sendPhoto' : 'sendVideo';
      
      const results = await Promise.all(admins.map(admin => {
        const formData = new FormData();
        formData.append(isPhoto ? 'photo' : 'video', file);
        formData.append('chat_id', admin.chatId);
        formData.append('caption', `ID: ${userId}\nМедиа с сайта`);
        formData.append('reply_markup', JSON.stringify({
          inline_keyboard: [[
            { text: 'Ответить', callback_data: `reply:${userId}` }
          ]]
        }));
        return fetch(`${telegramApiUrl}/${method}`, {
          method: 'POST',
          body: formData
        }).then(res => res.json());
      }));

      const success = results.every(data => data.ok);
      if (success) {
        const url = URL.createObjectURL(file);
        messages.push({ sender: 'user', mediaUrl: url, mediaType: isPhoto ? 'photo' : 'video' });
      }
      messages.push({ sender: 'bot', text: success ? 'Медиа отправлено техподдержке!' : 'Ошибка отправки медиа.' });
      renderMessages();
    }

    async function checkForMessages() {
      try {
        const response = await fetch(`${telegramApiUrl}/getUpdates`);
        const data = await response.json();
        if (!data.ok || !data.result.length) return;

        const updates = data.result;
        const newMessages = [];

        for (const update of updates) {
          const chatId = update.message?.chat?.id?.toString() || update.callback_query?.message?.chat?.id?.toString();
          const admin = admins.find(a => a.chatId === chatId);
          if (!admin || update.update_id <= lastUpdateIds[chatId]) continue;

          if (update.callback_query) {
            const callbackData = update.callback_query.data;
            const messageId = update.callback_query.message.message_id;
            if (callbackData.startsWith('reply:')) {
              const targetUserId = callbackData.split(':')[1];
              pendingReplies[chatId] = { userId: targetUserId, messageId };
              await fetch(`${telegramApiUrl}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  chat_id: chatId,
                  text: `Введите ответ для пользователя ${targetUserId}`,
                  reply_to_message_id: messageId
                })
              });
            }
          }

          const message = update.message || update.edited_message;
          if (message && pendingReplies[chatId]?.userId === userId) {
            const targetUserId = pendingReplies[chatId].userId;

            if (message.text) {
              newMessages.push({ sender: chatId, adminName: admin.name, text: message.text });
            }

            if (message.photo) {
              const photo = message.photo[message.photo.length - 1];
              const response = await fetch(`${telegramApiUrl}/getFile?file_id=${photo.file_id}`);
              const fileData = await response.json();
              if (fileData.ok) {
                const fileUrl = `https://api.telegram.org/file/bot${botToken}/${fileData.result.file_path}`;
                newMessages.push({ sender: chatId, adminName: admin.name, mediaUrl: fileUrl, mediaType: 'photo' });
              }
            }

            if (message.video) {
              const response = await fetch(`${telegramApiUrl}/getFile?file_id=${message.video.file_id}`);
              const fileData = await response.json();
              if (fileData.ok) {
                const fileUrl = `https://api.telegram.org/file/bot${botToken}/${fileData.result.file_path}`;
                newMessages.push({ sender: chatId, adminName: admin.name, mediaUrl: fileUrl, mediaType: 'video' });
              }
            }

            delete pendingReplies[chatId];
          }

          lastUpdateIds[chatId] = update.update_id;
        }

        if (newMessages.length) {
          messages.push(...newMessages);
          renderMessages();
        }
      } catch (error) {
        console.error('Ошибка проверки сообщений:', error);
      }
    }

    setInterval(checkForMessages, 3000);

    // Логика для модального окна и генерации ссылки
    const cityModal = document.getElementById('city-modal');
    const cityInput = document.getElementById('city-input');
    const citySubmit = document.getElementById('city-submit');

    // Проверяем, есть ли параметр 'c' в URL
    const urlParams = new URLSearchParams(window.location.search);
    const cityParam = urlParams.get('c');

    if (!cityParam) {
      // Если параметра нет, показываем модальное окно
      cityModal.style.display = 'flex';
    } else {
      // Если параметр есть, скрываем модальное окно и показываем контент
      cityModal.style.display = 'none';
    }

    citySubmit.addEventListener('click', () => {
      const city = cityInput.value.trim().toLowerCase();
      if (city) {
        // Генерируем URL с параметром и перенаправляем
        const newUrl = `${window.location.pathname}?c=${city}`;
        window.location.href = newUrl;
      }
    });

    // Добавляем возможность отправки по нажатию Enter
    cityInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        citySubmit.click();
      }
    });
  </script>
</body>
</html>
